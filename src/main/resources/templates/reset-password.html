<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Password Reset</title>
</head>

<body>
    <h1>Password Reset</h1>
    <p>Enter your email or username to reset your password.</p>
    <form id="password-reset-form" method="POST">
        <label for="email">Email or Username:</label><br>
        <input type="text" id="email" name="email" required><br>
        <input type="submit" value="Reset Password">
    </form>

    <form id="otp-form" style="display: none;">
        <p>Please enter your OTP</p>
        <label for="otp">Enter OTP:</label><br>
        <input type="text" id="otp" name="otp" required><br>
        <input type="submit" value="Verify OTP">
    </form>

    <form id="new-password-form" style="display: none;">
        <p>Enter your new password</p>
        <label for="new-password">Enter New Password:</label><br>
        <input type="password" id="new-password" name="new-password" required><br>
        <label for="confirm-password">Confirm New Password:</label><br>
        <input type="password" id="confirm-password" name="confirm-password" required><br>
        <input type="submit" value="Change Password">
    </form>

    <script>
        var email;
        document.getElementById('password-reset-form').addEventListener('submit', function (event) {
            event.preventDefault();

            email = document.getElementById('email').value;

            fetch('/auth/password-reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Hide password reset form and show OTP form
                        document.getElementById('password-reset-form').style.display = 'none';
                        document.getElementById('otp-form').style.display = 'block';

                        // Store the token
                        localStorage.setItem('passwordResetToken', data.token);
                    }
                    // Alert the message
                    alert(data.message);
                })
                .catch(error => {
                    alert("Error: " + error.message); // Display the error message from the server
                });
        });

        document.getElementById('otp-form').addEventListener('submit', function (event) {
            event.preventDefault();

            var otp = document.getElementById('otp').value;

            fetch('/auth/verify-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email, otp: otp }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Hide OTP form and show new password form
                        document.getElementById('otp-form').style.display = 'none';
                        document.getElementById('new-password-form').style.display = 'block';
                    }
                    // Alert the message
                    alert(data.message);
                })
                .catch(error => {
                    alert("Error: " + error.message); // Display the error message from the server
                });
        });

        document.getElementById('new-password-form').addEventListener('submit', function (event) {
            event.preventDefault();

            var newPassword = document.getElementById('new-password').value;
            var confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                alert("Passwords do not match.");
                return;
            }

            // Get the token
            var token = localStorage.getItem('passwordResetToken');

            fetch('/auth/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ token: token, newPassword: newPassword }),
            })
                .then(response => response.json())
                .then(data => {
                    // Alert the message
                    alert(data.message);
                })
                .catch(error => {
                    alert("Error: " + error.message); // Display the error message from the server
                });
        });
    </script>
</body>

</html>